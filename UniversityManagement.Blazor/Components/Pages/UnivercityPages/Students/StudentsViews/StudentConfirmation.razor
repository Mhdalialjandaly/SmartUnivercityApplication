@page "/student/confirmation"
@page "/student/confirmation/{selectedStudentId}"
@inject NavigationManager Navigation
@inject ICourseRegistrationServices RegistrationService
@inject IStudentServices StudentService
@inject IUserServices CurrentUserService

@rendermode InteractiveServer

<PageTitle>تأكيد التسجيل - الجامعة الذكية</PageTitle>

<style>
    /* تخصيصات الجامعة الذكية */
    .university-primary {
        color: white;
        background-color:#333;
    }
    
   
    .university-accent {
        background-color: #e74c3c;
    }
    
    .text-university {
        color: #2c3e50;
    }
    
    .border-university {
        border-color: #2c3e50 !important;
    }
    
    .btn-university {
        background-color: #2c3e50;
        color: lemonchiffon;
        border-color: #2c3e50;
    }
    
    .btn-university:hover {
        background-color: #1a252f;
        border-color: #efe;
    }
    
    .btn-outline-university {
        border-color: #2c3e50;
        color: #eee;
    }
    
    .btn-outline-university:hover {
        background-color: #2c3e50;
        color: white;
    }
    
  
    
    
    
    .table-header-university {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
    }
    
    
</style>

@if (isLoadingStudents)
{
    <div class="d-flex justify-content-center my-5 py-5">
        <div class="spinner-border text-university" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
        </div>
    </div>
}
else
{
    <div class="main-panel bg-dark">
        <div class="content">
            <div class="page-inner" >
                <div class="container py-4">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <!-- بطاقة اختيار الطالب -->
                            <div class="card mb-4 shadow-sm border-university">
                                <div class="card-header card-header-university text-white">
                                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>اختيار الطالب</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8 mb-3 mb-md-0">
                                            <div class="input-group">
                                                <span class="input-group-text university-primary">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input type="text" class="form-control" placeholder="ابحث عن طالب..."
                                                       @bind="searchTerm" @bind:event="oninput" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" @bind="selectedStudentId">
                                                <option value="">-- اختر طالبا --</option>
                                                @foreach (var student in filteredStudents)
                                                {
                                                    <option value="@student.StudentId">@student.FullName (@student.StudentId)</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @if (selectedStudentId != 0)
                            {
                                @if (isLoadingDetails)
                                {
                                    <div class="d-flex justify-content-center my-5 py-5">
                                        <div class="spinner-border text-university" style="width: 3rem; height: 3rem;" role="status">
                                            <span class="visually-hidden">جاري التحميل...</span>
                                        </div>
                                    </div>
                                }
                                else if (registrations == null || !registrations.Any())
                                {
                                    <div class="alert alert-danger text-center my-5">
                                        <i class="fas fa-exclamation-triangle me-2"></i> لا توجد بيانات تسجيل متاحة لهذا الطالب
                                    </div>
                                }
                                else
                                {
                                    <!-- بطاقة تفاصيل الطالب -->
                                    <div class="card mb-4 shadow-sm border-university">
                                        <div class="card-header card-header-university text-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>معلومات الطالب</h5>
                                                <span class="badge bg-light text-university fs-6 py-2 px-3">
                                                    <i class="fas fa-wallet me-2"></i> الرصيد: @studentAccountBalance.ToString("C")
                                                </span>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <div class="p-3 bg-light rounded">
                                                        <p class="mb-2"><strong><i class="fas fa-user me-2 text-university"></i>الاسم:</strong> @studentName</p>
                                                        <p class="mb-0"><strong><i class="fas fa-building me-2 text-university"></i>القسم:</strong> @departmentName</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <div class="p-3 bg-light rounded">
                                                        <p class="mb-2"><strong><i class="fas fa-phone me-2 text-university"></i>رقم الهاتف:</strong> @phoneNumber</p>
                                                        <p class="mb-0"><strong><i class="fas fa-envelope me-2 text-university"></i>البريد الإلكتروني:</strong> @email</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="p-3 bg-light rounded">
                                                        <p class="mb-2"><strong><i class="fas fa-info-circle me-2 text-university"></i>الحالة:</strong> <span class="badge @GetStatusBadgeClass(studentStatus)">@studentStatus</span></p>
                                                        <p class="mb-0"><strong><i class="fas fa-calendar-alt me-2 text-university"></i>تاريخ التسجيل:</strong> @registrationDate?.ToString("yyyy/MM/dd")</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- بطاقة تفاصيل التسجيل -->
                                    <div class="card shadow-sm border-university">
                                        <div class="card-header card-header-university text-white text-center py-3">
                                            <h3 class="mb-0 fw-bold">
                                                <i class="fas fa-check-circle me-2"></i>تفاصيل التسجيل
                                            </h3>
                                        </div>
                                        <div class="card-body p-4">
                                            <div class="alert alert-university mb-4">
                                                <h5 class="fw-bold text-university"><i class="fas fa-receipt me-2"></i>ملخص التسجيل</h5>
                                                <div class="row mt-3">
                                                    <div class="col-md-6 mb-3">
                                                        <p class="mb-2"><strong><i class="fas fa-id-card me-2 text-university"></i>رقم الطالب:</strong> @selectedStudentId</p>
                                                        <p class="mb-0"><strong><i class="fas fa-calendar me-2 text-university"></i>الفصل الدراسي:</strong> @semester</p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <p class="mb-2"><strong><i class="fas fa-book me-2 text-university"></i>عدد المواد:</strong> @registrations.Count مواد</p>
                                                        <p class="mb-0">
                                                            <strong><i class="fas fa-money-bill-wave me-2 text-university"></i>إجمالي الكلفة:</strong>
                                                            <span class="text-university fw-bold">@totalCost.ToString("C")</span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card mb-4 border-university">
                                                <div class="card-header bg-light">
                                                    <h6 class="mb-0 fw-bold text-university"><i class="fas fa-book-open me-2"></i>المواد المسجلة</h6>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-hover mb-0">
                                                            <thead class="table-header-university">
                                                                <tr>
                                                                    <th><i class="fas fa-hashtag me-2"></i>رمز المادة</th>
                                                                    <th><i class="fas fa-book me-2"></i>اسم المادة</th>
                                                                    <th class="text-center"><i class="fas fa-clock me-2"></i>الساعات</th>
                                                                    <th><i class="fas fa-money-bill-wave me-2"></i>الكلفة</th>
                                                                    <th><i class="fas fa-info-circle me-2"></i>حالة التسجيل</th>
                                                                    <th><i class="fas fa-calendar-day me-2"></i>تاريخ التسجيل</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var reg in registrations)
                                                                {
                                                                    <tr>
                                                                        <td>@reg.Course?.Code</td>
                                                                        <td>@reg.Course?.Name</td>
                                                                        <td class="text-center">@reg.Course?.CreditHours</td>
                                                                        <td>@reg.AmountPaid.ToString("C")</td>
                                                                        <td>
                                                                            <span class="badge @GetStatusBadgeClass(reg.Status)">
                                                                                @reg.Status
                                                                            </span>
                                                                        </td>
                                                                        <td>@reg.RegistrationDate.ToString("yyyy/MM/dd")</td>
                                                                    </tr>
                                                                }
                                                                <tr class="table-light fw-bold">
                                                                    <td colspan="2">الإجمالي</td>
                                                                    <td class="text-center">@totalCreditHours</td>
                                                                    <td>@totalCost.ToString("C")</td>
                                                                    <td></td>
                                                                    <td></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="alert alert-warning">
                                                <h6 class="fw-bold text-university"><i class="fas fa-exclamation-triangle me-2"></i>تعليمات مهمة:</h6>
                                                <ul class="mb-0">
                                                    <li><i class="fas fa-check-circle me-2 text-success"></i>تم خصم الكلفة من حسابك الجامعي</li>
                                                    <li><i class="fas fa-edit me-2 text-primary"></i>يمكنك تعديل التسجيل خلال 48 ساعة من الآن</li>
                                                    <li><i class="fas fa-calendar-check me-2 text-info"></i>الرجاء مراجعة الجدول الزمني للمواد المسجلة</li>
                                                    <li><i class="fas fa-headset me-2 text-secondary"></i>لأي استفسار، تواصل مع شؤون الطلاب</li>
                                                </ul>
                                            </div>

                                            <div class="d-grid gap-3 mt-4">
                                                <a href="/student/schedule" class="btn btn-university btn-lg py-3">
                                                    <i class="fas fa-calendar me-2"></i>عرض الجدول الزمني
                                                </a>
                                                <a href="/" class="btn btn-outline-university py-3">
                                                    <i class="fas fa-tachometer-alt me-2"></i>الذهاب للوحة التحكم
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoadingStudents = true;
    private bool isLoadingDetails = true;
    private List<StudentDto> allStudents = new();
    private List<StudentDto> filteredStudents = new();
    private string searchTerm = string.Empty;
    private int _selectedStudentId;

    private int selectedStudentId
    {
        get => _selectedStudentId;
        set
        {
            if (_selectedStudentId != value)
            {
                _selectedStudentId = value;
                InvokeAsync(() => LoadStudentDetails());
            }
        }
    }
    private List<CourseRegistrationDto> registrations = new();
    private string studentName = string.Empty;
    private string departmentName = string.Empty;
    private string phoneNumber = string.Empty;
    private string email = string.Empty;
    private string studentStatus = string.Empty;
    private DateTime? registrationDate;
    private string semester = string.Empty;
    private decimal totalCost;
    private int totalCreditHours;
    private decimal studentAccountBalance;

    [Parameter]
    public int SelectedStudentId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // جلب جميع الطلاب
            allStudents = await StudentService.GetAllStudentsAsync();
            filteredStudents = allStudents;

            // إذا كان هناك طالب محدد في الرابط
            if (SelectedStudentId != 0)
            {
                selectedStudentId = SelectedStudentId;
                await LoadStudentDetails();
            }
            else
            {
                // تحديد الطالب الحالي إذا لم يكن هناك طالب محدد
                var currentStudentId = 0 ;
                if (currentStudentId != 0 && allStudents.Any(s => s.Id == currentStudentId))
                {
                    selectedStudentId = currentStudentId;
                    await LoadStudentDetails();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading students: {ex.Message}");
        }
        finally
        {
            isLoadingStudents = false;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedStudentId != 0 && SelectedStudentId != selectedStudentId)
        {
            selectedStudentId = SelectedStudentId;
            await LoadStudentDetails();
        }
    }

    private async Task LoadStudentDetails()
    {
        if (SelectedStudentId == 0) return;

        isLoadingDetails = true;
        try
        {
            // جلب تفاصيل الطالب
            var student = await StudentService.GetStudentByIdAsync(selectedStudentId);
            if (student != null)
            {
                studentName = student.FullName;
                departmentName = student.Department?.Name ?? "غير محدد";
                phoneNumber = student.Phone ?? "غير متوفر";
                email = student.Email ?? "غير متوفر";
                studentStatus = student.Status.ToString();
                registrationDate = student.RegistrationDate;
                studentAccountBalance = await StudentService.GetStudentAccountBalanceAsync(selectedStudentId);
            }

            // جلب تسجيلات الطالب
            registrations = await RegistrationService.GetRegistrationsByStudentIdAsync(selectedStudentId);

            // حساب الفصل الدراسي الحالي
            semester = CalculateCurrentSemester();

            // حساب الإجماليات
            totalCost = registrations.Sum(r => r.AmountPaid);
            totalCreditHours = registrations.Sum(r => r.Course?.CreditHours ?? 0);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading student details: {ex.Message}");
        }
        finally
        {
            isLoadingDetails = false;
            StateHasChanged();
        }
    }

    private string CalculateCurrentSemester()
    {
        var now = DateTime.Now;
        int year = now.Year;
        string semester = now.Month >= 9 ? "الفصل الأول" : "الفصل الثاني";
        return $"{year}-{year + 1} - {semester}";
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-success",
            "Completed" => "bg-primary",
            "Suspended" => "bg-danger",
            "Pending" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private void FilterStudents()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredStudents = allStudents;
        }
        else
        {
            var term = searchTerm.ToLower();
            filteredStudents = allStudents
                .Where(s => s.FullName.ToLower().Contains(term) ||
                           s.StudentId.ToLower().Contains(term) ||
                           (s.Email?.ToLower().Contains(term) ?? false) ||
                           (s.Phone?.Contains(term) ?? false))
                .ToList();
        }
    }
}