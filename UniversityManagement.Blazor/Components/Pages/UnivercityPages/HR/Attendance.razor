@page "/hr/attendance"
@attribute [Authorize]
@inject IAttendanceServices AttendanceService
@inject IUserServices UserService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>الحضور والانصراف - الجامعة الذكية</PageTitle>

<div class="main-panel">
    <div class="content">
        <div class="page-inner">
            <div class="hr-attendance-container" dir="rtl">
                <!-- شريط العنوان مع خلفية متدرجة -->
                <div class="admin-header bg-gradient-primary">
                    <div class="container-fluid">
                        <div class="header-content">
                            <div class="header-title">
                                <h1>
                                    <i class="fas fa-clock"></i>
                                    <span>الحضور والانصراف</span>
                                </h1>
                                <nav class="breadcrumb">
                                    <a href="/" class="breadcrumb-item"><i class="fas fa-home"></i></a>
                                    <a href="/hr" class="breadcrumb-item">الموارد البشرية</a>
                                    <span class="breadcrumb-item active">الحضور والانصراف</span>
                                </nav>
                            </div>
                            <div class="header-actions">
                                <button class="btn btn-light btn-refresh" @onclick="RefreshAttendance">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>تحديث البيانات</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- بطاقات الإحصاءات -->
                <div class="stats-cards">
                    <div class="container-fluid">
                        <div class="row">
                            <!-- بطاقة إجمالي الموظفين -->
                            <div class="col-md-3">
                                <div class="stat-card card-dark bg-primary-gradient">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <h2 class="mb-0">@attendanceSummary.TotalEmployees</h2>
                                                <p class="mb-0">إجمالي الموظفين</p>
                                            </div>
                                            <div class="icon-shape bg-primary-light rounded-circle">
                                                <i class="fas fa-users text-primary"></i>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <a href="/hr/employees" class="text-white">
                                                عرض الموظفين <i class="fas fa-arrow-left"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- بطاقة الحاضرون -->
                            <div class="col-md-3">
                                <div class="stat-card card-dark bg-success-gradient">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <h2 class="mb-0">@attendanceSummary.PresentCount</h2>
                                                <p class="mb-0">الحاضرون</p>
                                            </div>
                                            <div class="icon-shape bg-success-light rounded-circle">
                                                <i class="fas fa-check-circle text-success"></i>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <a href="#" @onclick="() => FilterAttendance(AttendanceStatus.Present)" class="text-white">
                                                عرض الحاضرين <i class="fas fa-arrow-left"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- بطاقة الغائبون -->
                            <div class="col-md-3">
                                <div class="stat-card card-dark bg-danger-gradient">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <h2 class="mb-0">@attendanceSummary.AbsentCount</h2>
                                                <p class="mb-0">الغائبون</p>
                                            </div>
                                            <div class="icon-shape bg-danger-light rounded-circle">
                                                <i class="fas fa-times-circle text-danger"></i>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <a href="#" @onclick="() => FilterAttendance(AttendanceStatus.Absent)" class="text-white">
                                                عرض الغائبين <i class="fas fa-arrow-left"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- بطاقة متوسط الساعات -->
                            <div class="col-md-3">
                                <div class="stat-card card-dark bg-info-gradient">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <h2 class="mb-0">@attendanceSummary.AverageHours.ToString("F2")</h2>
                                                <p class="mb-0">متوسط الساعات</p>
                                            </div>
                                            <div class="icon-shape bg-info-light rounded-circle">
                                                <i class="fas fa-clock text-info"></i>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <a href="#" @onclick="() => LoadMonthlyAttendance()" class="text-white">
                                                التقرير الشهري <i class="fas fa-arrow-left"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- لوحة التحكم -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <h4 class="card-title">سجل الحضور والانصراف</h4>
                            <div class="ml-auto">
                                <button class="btn btn-primary btn-round" data-bs-toggle="modal" data-bs-target="#addAttendanceModal">
                                    <i class="fas fa-plus me-2"></i>إضافة حضور
                                </button>
                                <div class="dropdown d-inline">
                                    <button class="btn btn-secondary btn-round dropdown-toggle" type="button" data-toggle="dropdown">
                                        <i class="fas fa-bolt me-2"></i>روابط سريعة
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="/hr/employees"><i class="fas fa-users me-2"></i>إدارة الموظفين</a>
                                        <a class="dropdown-item" href="/hr/leaves"><i class="fas fa-calendar-alt me-2"></i>طلبات الإجازة</a>
                                        <a class="dropdown-item" href="/hr/reports"><i class="fas fa-chart-bar me-2"></i>التقارير</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- علامات التبويب -->
                        <ul class="nav nav-pills nav-secondary" id="attendanceTabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" id="daily-tab" @onclick="() => LoadDailyAttendance()">
                                    <i class="fas fa-calendar-day me-2"></i> اليومي
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="weekly-tab" @onclick="() => LoadWeeklyAttendance()">
                                    <i class="fas fa-calendar-week me-2"></i> الأسبوعي
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="monthly-tab" @onclick="() => LoadMonthlyAttendance()">
                                    <i class="fas fa-calendar-alt me-2"></i> الشهري
                                </button>
                            </li>
                        </ul>

                        <!-- شريط البحث والتحكم -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div class="input-icon">
                                        <input type="text" class="form-control" placeholder="ابحث عن موظف..." 
                                               @bind="searchTerm" @oninput="SearchAttendance">
                                        <span class="input-icon-addon">
                                            <i class="fas fa-search"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <input type="date" class="form-control" @onchange="LoadAttendanceByDate">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <select class="form-control"  @onchange="FilterByDepartment">
                                        <option value="0">جميع الأقسام</option>
                                        @foreach (var dept in departments)
                                        {
                                            <option value="@dept.Id">@dept.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- جدول الحضور -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>الموظف</th>
                                        <th>التاريخ</th>
                                        <th>وقت الحضور</th>
                                        <th>وقت الانصراف</th>
                                        <th>الساعات</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (dailyAttendance.Any())
                                    {
                                        @for (int i = 0; i < dailyAttendance.Count; i++)
                                        {
                                            var attendance = dailyAttendance[i];
                                            <tr>
                                                <td>@attendance.Id</td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img src="https://ui-avatars.com/api/?name=@Uri.EscapeDataString(attendance.EmployeeName)&background=2c3e50&color=fff"
                                                             class="rounded-circle mr-3"
                                                             width="40" height="40"
                                                             alt="صورة الموظف" />
                                                        <div>
                                                            <span class="d-block font-weight-bold">@attendance.EmployeeName</span>
                                                            <small class="text-muted">@GetEmployeePosition(attendance.EmployeeId)</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>@attendance.Date.ToString("yyyy-MM-dd")</td>
                                                <td>@(attendance.CheckInTime?.ToString("HH:mm") ?? "-")</td>
                                                <td>@(attendance.CheckOutTime?.ToString("HH:mm") ?? "-")</td>
                                                <td>@attendance.HoursWorked.ToString("F2")</td>
                                                <td>
                                                    <span class="badge @GetStatusClass(attendance.Status)">
                                                        @GetStatusText(attendance.Status)
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <div class="dropdown-menu">
                                                            <a class="dropdown-item" href="#" @onclick="() => EditAttendance(attendance)">
                                                                <i class="fas fa-edit mr-2"></i> تعديل
                                                            </a>
                                                            <a class="dropdown-item" href="#" @onclick="() => ViewAttendanceDetails(attendance)">
                                                                <i class="fas fa-eye mr-2"></i> عرض التفاصيل
                                                            </a>
                                                            <div class="dropdown-divider"></div>
                                                            <a class="dropdown-item text-danger" href="#" @onclick="() => DeleteAttendance(attendance.Id)">
                                                                <i class="fas fa-trash mr-2"></i> حذف
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="8">
                                                <div class="text-center py-5">
                                                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                                                    <p class="text-muted">لا توجد بيانات حضور</p>
                                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAttendanceModal">
                                                        <i class="fas fa-plus mr-2"></i> إضافة حضور جديد
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- الترقيم -->
                        @if (totalPages > 1)
                        {
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted">
                                    عرض @((currentPage - 1) * pageSize + 1)-@Math.Min(currentPage * pageSize, totalRecords) من @totalRecords
                                </div>
                                <ul class="pagination">
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="() => GoToPage(1)">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="() => GoToPage(currentPage - 1)">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>

                                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                    {
                                        <li class="page-item @(i == currentPage ? "active" : "")">
                                            <a class="page-link" href="#" @onclick="() => GoToPage(i)">@i</a>
                                        </li>
                                    }

                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="() => GoToPage(currentPage + 1)">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="() => GoToPage(totalPages)">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- مودال إضافة/تعديل حضور -->
<div class="modal fade" id="addAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clock"></i> @(isEditMode ? "تعديل الحضور" : "إضافة حضور جديد")
                </h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>الموظف <span class="text-danger">*</span></label>
                                <select class="form-control" @bind="newAttendance.EmployeeId" required>
                                    <option value="0">اختر الموظف</option>
                                    @foreach (var employee in employees)
                                    {
                                        <option value="@employee.Id">@($"{employee.FirstName} {employee.LastName}")</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>التاريخ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" @bind="newAttendance.Date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>وقت الحضور</label>
                                <input type="time" class="form-control" @bind="DatecheckInTime">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>وقت الانصراف</label>
                                <input type="time" class="form-control" @bind="DatecheckOutTime">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>الحالة <span class="text-danger">*</span></label>
                                <select class="form-control" @bind="newAttendance.Status" required>
                                    <option value="حاضر">حاضر</option>
                                    <option value="غائب">غائب</option>
                                    <option value="إجازة">إجازة</option>
                                    <option value="تأخير">تأخير</option>
                                    <option value="مهمة عمل">مهمة عمل</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>الساعات</label>
                                <input type="number" step="0.01" class="form-control" @bind="newAttendance.HoursWorked">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group">
                                <label>الملاحظات</label>
                                <textarea class="form-control" rows="3" @bind="newAttendance.Notes" placeholder="أدخل الملاحظات"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>إلغاء
                </button>
                <button type="button" class="btn btn-primary" @onclick="SaveAttendance">
                    <i class="fas fa-save me-2"></i>حفظ الحضور
                </button>
            </div>
        </div>
    </div>
</div>

<!-- مودال عرض تفاصيل الحضور -->
<div class="modal fade" id="attendanceDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clock"></i> تفاصيل الحضور
                </h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @if (selectedAttendance != null)
                {
                    <div class="details-section">
                        <div class="detail-item">
                            <span>الموظف:</span>
                            <strong>@selectedAttendance.EmployeeName</strong>
                        </div>
                        <div class="detail-item">
                            <span>التاريخ:</span>
                            <strong>@selectedAttendance.Date.ToString("yyyy-MM-dd")</strong>
                        </div>
                        <div class="detail-item">
                            <span>وقت الحضور:</span>
                            <strong>@(selectedAttendance.CheckInTime?.ToString("HH:mm") ?? "-")</strong>
                        </div>
                        <div class="detail-item">
                            <span>وقت الانصراف:</span>
                            <strong>@(selectedAttendance.CheckOutTime?.ToString("HH:mm") ?? "-")</strong>
                        </div>
                        <div class="detail-item">
                            <span>الساعات المُحسوبة:</span>
                            <strong>@selectedAttendance.HoursWorked.ToString("F2") ساعة</strong>
                        </div>
                        <div class="detail-item">
                            <span>الحالة:</span>
                            <strong>
                                <span class="badge @GetStatusClass(selectedAttendance.Status)">
                                    @GetStatusText(selectedAttendance.Status)
                                </span>
                            </strong>
                        </div>
                        @if (!string.IsNullOrEmpty(selectedAttendance.Notes))
                        {
                            <div class="detail-item">
                                <span>الملاحظات:</span>
                                <strong>@selectedAttendance.Notes</strong>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>إغلاق
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* أنماط CSS جديدة */
    .hr-attendance-container {
        font-family: 'Tajawal', sans-serif;
        background-color: #f8fafc;
        min-height: 100vh;
    }
    
    .admin-header {
        padding: 1.5rem 0;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
    }
    
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .header-title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .breadcrumb {
        display: flex;
        padding: 0;
        margin: 0;
        background: transparent;
    }
    
    .breadcrumb-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: rgba(255,255,255,0.8);
    }
    
    .breadcrumb-item.active {
        color: white;
        font-weight: 500;
    }
    
    .breadcrumb-item a {
        color: rgba(255,255,255,0.8);
        text-decoration: none;
        transition: color 0.2s;
    }
    
    .breadcrumb-item a:hover {
        color: white;
    }
    
    .btn-refresh {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }
    
    /* بطاقات الإحصاءات */
    .stats-cards {
        margin-bottom: 2rem;
    }
    
    .stat-card {
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        overflow: hidden;
        height: 100%;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .card-dark {
        color: white;
    }
    
    .bg-primary-gradient {
        background: linear-gradient(135deg, #1f6feb 0%, #1554c7 100%);
    }
    
    .bg-danger-gradient {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .bg-success-gradient {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .bg-info-gradient {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }
    
    .icon-shape {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .bg-primary-light {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .bg-danger-light {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .bg-success-light {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .bg-info-light {
        background: rgba(255, 255, 255, 0.2);
    }
    
    /* تبويبات التنقل */
    .nav-pills .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }
    
    .nav-pills .nav-link:hover {
        color: #2c3e50;
        background-color: #f8f9fa;
    }
    
    .nav-pills .nav-link.active {
        color: white;
        background-color: #2c3e50;
    }
    
    /* البحث والفلاتر */
    .input-icon {
        position: relative;
    }
    
    .input-icon .form-control {
        padding-right: 2.5rem;
    }
    
    .input-icon-addon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    
    /* جدول الحضور */
    .table th {
        background: #f8f9fa;
        color: #2c3e50;
        font-weight: 600;
        padding: 1rem;
        text-align: right;
        border-bottom: 1px solid #e9ecef;
    }
    
    .table td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }
    
    .badge {
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-present {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .status-absent {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .status-leave {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }
    
    .status-late {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }
    
    .status-business {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }
    
    .btn-actions {
        background: none;
        border: none;
        color: #6c757d;
        padding: 0.5rem;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .btn-actions:hover {
        background: #f8f9fa;
        color: #2c3e50;
    }
    
    .dropdown-menu {
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-radius: 0.5rem;
        padding: 0.5rem;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }
    
    .dropdown-item:hover {
        background: #f8f9fa;
    }
    
    .dropdown-item.text-danger:hover {
        background: rgba(239, 68, 68, 0.1);
    }
    
    /* الترقيم */
    .pagination {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0;
    }
    
    .page-item .page-link {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e9ecef;
        color: #6c757d;
        border-radius: 0.25rem;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .page-item.active .page-link {
        background: #2c3e50;
        border-color: #2c3e50;
        color: white;
    }
    
    .page-item:not(.active) .page-link:hover {
        background: #f8f9fa;
        color: #2c3e50;
    }
    
    .page-item.disabled .page-link {
        opacity: 0.5;
        pointer-events: none;
    }
    
    /* المودالات */
    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .modal-header {
        border-bottom: 1px solid #e9ecef;
        padding: 1.25rem;
    }
    
    .modal-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .details-section {
        margin-bottom: 1rem;
    }
    
    .details-section h6 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        border-radius: 0.25rem;
        transition: background-color 0.2s;
    }
    
    .detail-item:hover {
        background-color: #f8f9fa;
    }
    
    .detail-item span:first-child {
        color: #6c757d;
        font-weight: 500;
    }
    
    .detail-item strong {
        color: #2c3e50;
        font-weight: 500;
        text-align: left;
    }
    
    .modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
    }
    
    /* تصميم متجاوب */
    @@media (max-width: 992px) {
        .header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .input-icon {
            width: 100%;
        }
        
        .control-bar {
            flex-direction: column;
            gap: 1rem;
        }
    }
    
    @@media (max-width: 768px) {
        .table-responsive {
            overflow-x: auto;
        }
        
        .table {
            min-width: 800px;
        }
        
        .stat-card .card-body {
            flex-direction: column;
            gap: 1rem;
        }
        
        .icon-shape {
            display: none;
        }
    }
    
    @@media (max-width: 576px) {
        .modal-dialog {
            margin: 1rem;
        }
        
        .pagination-container {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>

@code {
    private List<AttendanceDto> dailyAttendance = new();
    private List<UserDto> employees = new();
    private List<DepartmentDto> departments = new();
    private AttendanceDto newAttendance = new();
    public string checkInTime { get; set; }
    public string checkOutTime { get; set; } 
    public DateTime DatecheckInTime { get; set; }
    public DateTime DatecheckOutTime { get; set; }
    private AttendanceDto selectedAttendance;
    private AttendanceSummaryDto attendanceSummary = new();
    
    private string searchTerm = "";
    private DateTime selectedDate = DateTime.Now;
    private int selectedDepartmentId = 0;
    private bool isEditMode = false;
    
    
    // ترقيم الصفحات
    private int currentPage = 1;
    private int totalPages = 1;
    private int pageSize = 10;
    private int totalRecords = 0;
    
    // الفلاتر
    private AttendanceStatus currentStatus = AttendanceStatus.All;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
        await LoadDepartments();
        await LoadAttendanceSummary();
        await LoadDailyAttendance();
    }
    
    private async Task LoadEmployees()
    {
        try
        {
            employees = await UserService.GetAllUsersAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employees: {ex.Message}");
        }
    }
    
    private async Task LoadDepartments()
    {
        try
        {
            // تحميل الأقسام من الخدمة المناسبة
            // departments = await DepartmentService.GetAllDepartmentsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading departments: {ex.Message}");
        }
    }
    
    private async Task LoadDailyAttendance()
    {
        try
        {
            // تحميل الحضور اليومي مع دعم التصفح
            dailyAttendance = await AttendanceService.GetAttendanceByDateAsync(selectedDate);
            
            // تطبيق البحث
            if (!string.IsNullOrEmpty(searchTerm))
            {
                dailyAttendance = dailyAttendance.Where(a => 
                    a.EmployeeName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
            }
            
            // حساب الترقيم
            totalRecords = dailyAttendance.Count;
            totalPages = (int)Math.Ceiling((double)totalRecords / pageSize);
            dailyAttendance = dailyAttendance.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading daily attendance: {ex.Message}");
        }
    }
    
    private async Task LoadWeeklyAttendance()
    {
        try
        {
            // تحميل الحضور الأسبوعي
            var startDate = DateTime.Now.AddDays(-7);
            dailyAttendance = await AttendanceService.GetAttendanceByDateRangeAsync(startDate,DateTime.Now);
            totalRecords = dailyAttendance.Count;
            totalPages = (int)Math.Ceiling((double)totalRecords / pageSize);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading weekly attendance: {ex.Message}");
        }
    }
    
    private async Task LoadMonthlyAttendance()
    {
        try
        {
            // تحميل الحضور الشهري
            var startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            var endDate = startDate.AddMonths(1).AddDays(-1);
            dailyAttendance = await AttendanceService.GetAttendanceByDateRangeAsync(startDate, endDate);
            totalRecords = dailyAttendance.Count;
            totalPages = (int)Math.Ceiling((double)totalRecords / pageSize);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading monthly attendance: {ex.Message}");
        }
    }
    
    private async Task LoadAttendanceSummary()
    {
        try
        {
            var startDate = DateTime.Now.AddDays(-7);
            var endDate = DateTime.Now;
            attendanceSummary = await AttendanceService.GetAttendanceSummaryAsync(startDate, endDate);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading attendance summary: {ex.Message}");
        }
    }
    
    private async Task RefreshAttendance()
    {
        await LoadAttendanceSummary();
        await LoadDailyAttendance();
        StateHasChanged();
    }
    
    private async Task LoadAttendanceByDate(ChangeEventArgs e)
    {
        await LoadDailyAttendance();
    }
    
    private async Task SearchAttendance(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        currentPage = 1;
        await LoadDailyAttendance();
    }
    
    private async Task FilterByDepartment(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        selectedDepartmentId = string.IsNullOrEmpty(value) ? 0 : int.Parse(value);
        currentPage = 1;
        await LoadDailyAttendance();
    }
    
    private async Task FilterAttendance(AttendanceStatus status)
    {
        currentStatus = status;
        currentPage = 1;
        await LoadDailyAttendance();
    }
    
    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadDailyAttendance();
        }
    }
    
    private async Task SaveAttendance()
    {
        try
        {
            // تحويل الوقت إلى DateTime
            if (!string.IsNullOrEmpty(checkInTime.ToString()))
            {
                var checkInDateTime = DateTime.Parse($"{newAttendance.Date:yyyy-MM-dd} {DatecheckInTime}");
                newAttendance.CheckInTime = checkInDateTime;
            }
            
            if (!string.IsNullOrEmpty(checkOutTime.ToString()))
            {
                var checkOutDateTime = DateTime.Parse($"{newAttendance.Date:yyyy-MM-dd} {DatecheckInTime}");
                newAttendance.CheckOutTime = checkOutDateTime;
            }
            
            if (isEditMode)
            {
                await AttendanceService.UpdateAttendanceAsync(newAttendance.Id,newAttendance);
            }
            else
            {
                await AttendanceService.CreateAttendanceAsync(newAttendance);
            }
            
            // تحديث القائمة والإحصائيات
            await LoadAttendanceSummary();
            await LoadDailyAttendance();
            
            // إغلاق المودال
            await JS.InvokeVoidAsync("bootstrap.Modal.hide", "#addAttendanceModal");
            
            // إعادة تعيين النموذج
            newAttendance = new AttendanceDto();
            isEditMode = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving attendance: {ex.Message}");
        }
    }
    
    private async Task EditAttendance(AttendanceDto attendance)
    {
        isEditMode = true;
        newAttendance = attendance;
        checkInTime = attendance.CheckInTime?.ToString("HH:mm") ?? "";
        checkOutTime = attendance.CheckOutTime?.ToString("HH:mm") ?? "";
        
        // فتح المودال
        await JS.InvokeVoidAsync("bootstrap.Modal.getOrCreateInstance", "#addAttendanceModal");
    }
    
    private async Task ViewAttendanceDetails(AttendanceDto attendance)
    {
        selectedAttendance = attendance;
        // فتح المودال
        await JS.InvokeVoidAsync("bootstrap.Modal.getOrCreateInstance", "#attendanceDetailsModal");
    }
    
    private async Task DeleteAttendance(int attendanceId)
    {
        try
        {
            await AttendanceService.DeleteAttendanceAsync(attendanceId);
            
            // تحديث القائمة والإحصائيات
            await LoadAttendanceSummary();
            await LoadDailyAttendance();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting attendance: {ex.Message}");
        }
    }
    
    // Helper functions
    private string GetStatusClass(string status)
    {
        return status switch
        {
            "حاضر" => "status-present",
            "غائب" => "status-absent",
            "إجازة" => "status-leave",
            "تأخير" => "status-late",
            "مهمة عمل" => "status-business",
            _ => "status-present"
        };
    }
    
    private string GetStatusText(string status)
    {
        return status switch
        {
            "حاضر" => "حاضر",
            "غائب" => "غائب",
            "إجازة" => "إجازة",
            "تأخير" => "تأخير",
            "مهمة عمل" => "مهمة عمل",
            _ => status
        };
    }
    
    private string GetEmployeePosition(string employeeId)
    {
        var employee = employees.FirstOrDefault(e => e.Id == employeeId);
        return employee?.Position ?? "غير محدد";
    }
    
    public enum AttendanceStatus
    {
        All,
        Present,
        Absent,
        Leave
    }
}
