@page "/students"
@attribute [Authorize]
@inject UniversityDbContext _context
@rendermode InteractiveServer
@inject IMapper _mapper
@inject IStudentServices _studentService
@inject IDepartmentService _departmentService

<PageTitle>شؤون الطلاب - الجامعة الذكية</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 fw-bold text-primary">شؤون الطلاب</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">الرئيسية</a></li>
                            <li class="breadcrumb-item active">شؤون الطلاب</li>
                        </ol>
                    </nav>
                </div>
                <div class="d-flex gap-2">
                    <!-- أزرار الانتقال للواجهات -->
                    <a href="/apply/status" class="btn btn-outline-info">
                        <i class="fas fa-search me-2"></i>متابعة الطلبات
                    </a>
                    <a href="/apply" class="btn btn-outline-primary">
                        <i class="fas fa-file-alt me-2"></i>طلبات التقديم
                    </a>
                    <a href="/admin/applications" class="btn btn-outline-info">
                        <i class="fas fa-search me-2"></i>متابعة الادارة
                    </a>
                    <a href="/student/registrations" class="btn btn-outline-success">
                        <i class="fas fa-book me-2"></i>تسجيل المواد
                    </a>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                        <i class="fas fa-plus me-2"></i>إضافة طالب جديد
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- إحصائيات سريعة -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-primary border-start border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-muted">إجمالي الطلاب</h5>
                            <h2 class="mb-0 fw-bold">@totalStudents</h2>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-users fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success border-start border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-muted">الطلاب النشطين</h5>
                            <h2 class="mb-0 fw-bold">@activeStudents</h2>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-user-check fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning border-start border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-muted">الطلاب الجدد</h5>
                            <h2 class="mb-0 fw-bold">@newStudents</h2>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-user-plus fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info border-start border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="text-muted">متوسط GPA</h5>
                            <h2 class="mb-0 fw-bold">@averageGPA.ToString("F2")</h2>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- علامات التبويب -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs mb-4" id="studentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" @onclick="() => LoadStudents(StudentStatus.All)">جميع الطلاب</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab" @onclick="() => LoadStudents(StudentStatus.Active)">الطلاب النشطين</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="new-tab" data-bs-toggle="tab" data-bs-target="#new" type="button" role="tab" @onclick="() => LoadStudents(StudentStatus.New)">الطلاب الجدد</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="graduated-tab" data-bs-toggle="tab" data-bs-target="#graduated" type="button" role="tab" @onclick="() => LoadStudents(StudentStatus.Graduated)">الخريجون</button>
                </li>
            </ul>

            <div class="tab-content" id="studentTabsContent">
                <!-- جميع الطلاب -->
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-white">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0">قائمة الطلاب</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-md-end gap-2">
                                        <div class="input-group" style="max-width: 300px;">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" placeholder="بحث عن طالب..." @bind="searchTerm" @oninput="SearchStudents">
                                        </div>
                                        <select class="form-select" style="max-width: 150px;" @onchange="FilterByDepartment">
                                            <option value="">جميع الأقسام</option>
                                            @foreach (var dept in departments)
                                            {
                                                <option value="@dept.Id">@dept.Name</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>الاسم الكامل</th>
                                            <th>رقم الطالب</th>
                                            <th>القسم</th>
                                            <th>السنة الدراسية</th>
                                            <th>GPA</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (StudentsList.Any())
                                        {
                                            @for (int i = 0; i < StudentsList.Count; i++)
                                            {
                                                var student = StudentsList[i];
                                                <tr>
                                                    <td>@(i + 1)</td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(student.FirstName + " " + student.LastName))&background=0D6EFD&color=fff" class="rounded-circle me-2" width="32" height="32">
                                                            <span>@($"{student.FirstName} {student.LastName}")</span>
                                                        </div>
                                                    </td>
                                                    <td>@student.StudentId</td>
                                                    <td>@GetDepartmentName(student.DepartmentId)</td>
                                                    <td>@GetAcademicYear(student.RegistrationDate)</td>
                                                    <td>
                                                        @if (student.GPA != 0)
                                                        {
                                                            <span class="badge @(student.GPA >= 3.5 ? "bg-success" : student.GPA >= 2.5 ? "bg-warning" : "bg-danger")">@student.GPA.ToString("F2") </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="badge @(student.Status == StudentStatus.Active ? "bg-success" : student.Status == StudentStatus.Stoped ? "bg-warning" : "bg-secondary")">@student.Status</span>
                                                    </td>
                                                    <td>
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li><a class="dropdown-item" href="/students/@student.StudentId"><i class="fas fa-eye me-2"></i>عرض التفاصيل</a></li>
                                                                <li><a class="dropdown-item" href="/students/@student.StudentId/edit"><i class="fas fa-edit me-2"></i>تعديل</a></li>
                                                                <li><a class="dropdown-item" href="/students/@student.StudentId/invoices"><i class="fas fa-file-invoice me-2"></i>الفواتير</a></li>
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" @onclick="() => DeleteStudent(student.StudentId)"><i class="fas fa-trash me-2"></i>حذف</a></li>
                                                            </ul>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="8" class="text-center">لا توجد بيانات للطلاب</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- ترقيم الصفحات -->
                            @if (totalPages > 1)
                            {
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                            <a class="page-link" href="javascript:void(0)" @onclick="() => GoToPage(currentPage - 1)" tabindex="-1">السابق</a>
                                        </li>

                                        @for (int i = 1; i <= totalPages; i++)
                                        {
                                            <li class="page-item @(i == currentPage ? "active" : "")">
                                                <a class="page-link" href="javascript:void(0)" @onclick="() => GoToPage(i)">@i</a>
                                            </li>
                                        }

                                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                            <a class="page-link" href="javascript:void(0)" @onclick="() => GoToPage(currentPage + 1)">التالي</a>
                                        </li>
                                    </ul>
                                </nav>
                            }
                        </div>
                    </div>
                </div>

                <!-- علامات التبويب الأخرى -->
                <div class="tab-pane fade" id="active" role="tabpanel">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> سيتم عرض الطلاب النشطين هنا
                    </div>
                </div>
                <div class="tab-pane fade" id="new" role="tabpanel">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> سيتم عرض الطلاب الجدد هنا
                    </div>
                </div>
                <div class="tab-pane fade" id="graduated" role="tabpanel">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> سيتم عرض الخريجين هنا
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal إضافة طالب جديد -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة طالب جديد - المرحلة @currentStep من @totalSteps</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <!-- شريط التقدم -->
                    <div class="progress mb-4">
                        <div class="progress-bar" role="progressbar" style="width: @((currentStep / (double)totalSteps) * 100)%"></div>
                    </div>

                    <!-- المرحلة 1: المعلومات الأساسية -->
                    @if (currentStep == 1)
                    {
                        <div class="step-content">
                            <h5 class="mb-4">المعلومات الأساسية</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم الطالب *</label>
                                    <input type="text" class="form-control" placeholder="أدخل رقم الطالب" @bind="newStudent.StudentId" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">القسم *</label>
                                    <select class="form-select" @bind="newStudent.DepartmentId" required>
                                        <option value="">اختر القسم</option>
                                        @foreach (var dept in departments)
                                        {
                                            <option value="@dept.Id">@dept.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الاسم الأول *</label>
                                    <input type="text" class="form-control" placeholder="أدخل الاسم الأول" @bind="newStudent.FirstName" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">اسم العائلة *</label>
                                    <input type="text" class="form-control" placeholder="أدخل اسم العائلة" @bind="newStudent.LastName" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">السنة الدراسية</label>
                                    <input type="text" class="form-control" placeholder="أدخل السنة الدراسية" @bind="newStudent.AcademicYear">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">تاريخ الولادة</label>
                                    <input type="date" class="form-control" @bind="newStudent.BirthOfDate">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الجنس</label>
                                    <select class="form-select" @bind="newStudent.Sexual">
                                        <option value="true">ذكر</option>
                                        <option value="false">أنثى</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الديانة</label>
                                    <input type="text" class="form-control" placeholder="أدخل الديانة" @bind="newStudent.Religion">
                                </div>
                            </div>
                        </div>
                    }

                    <!-- المرحلة 2: معلومات الاتصال والعنوان -->
                    @if (currentStep == 2)
                    {
                        <div class="step-content">
                            <h5 class="mb-4">معلومات الاتصال والعنوان</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم الهاتف الأول *</label>
                                    <input type="tel" class="form-control" placeholder="أدخل رقم الهاتف" @bind="newStudent.Phone" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم الهاتف الثاني</label>
                                    <input type="tel" class="form-control" placeholder="أدخل رقم الهاتف الثاني" @bind="newStudent.SecoundPhone">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" placeholder="أدخل البريد الإلكتروني" @bind="newStudent.Email">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">محل السكن (م-ز-د) *</label>
                                    <input type="text" class="form-control" placeholder="أدخل محل السكن" @bind="newStudent.HomeAddress" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">رقم الدار</label>
                                    <input type="number" class="form-control" placeholder="أدخل رقم الدار" @bind="newStudent.HomeNumber">
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">العنوان الدائم *</label>
                                    <textarea class="form-control" rows="2" placeholder="أدخل العنوان الدائم" @bind="newStudent.FullAddress" required></textarea>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- المرحلة 3: المعلومات الوظيفية -->
                    @if (currentStep == 3)
                    {
                        <div class="step-content">
                            <h5 class="mb-4">المعلومات الوظيفية</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">هل أنت موظف؟</label>
                                    <select class="form-select" @bind="newStudent.TrueIsEmployee">
                                        <option value="false">لا</option>
                                        <option value="true">نعم</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">مكان العمل</label>
                                    <input type="text" class="form-control" placeholder="أدخل مكان العمل" @bind="newStudent.WorkAddress">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">قناة القبول الخاص</label>
                                    <select class="form-select" @bind="newStudent.TunnelId">
                                        <option value="">اختر قناة القبول</option>
                                        @foreach (var tunnel in tunnels)
                                        {
                                            <option value="@tunnel.Id">@tunnel.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">قسم المسجل عليه</label>
                                    <input type="text" class="form-control" placeholder="أدخل قسم التسجيل" @bind="newStudent.SubmissionDepartment">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">قناة التسجيل</label>
                                    <input type="text" class="form-control" placeholder="أدخل قناة التسجيل" @bind="newStudent.TunnelDepartment">
                                </div>
                            </div>
                        </div>
                    }

                    <!-- المرحلة 4: المعلومات الوطنية -->
                    @if (currentStep == 4)
                    {
                        <div class="step-content">
                            <h5 class="mb-4">المعلومات الوطنية</h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">رقم هوية الأحوال المدنية</label>
                                    <input type="text" class="form-control" placeholder="أدخل رقم الهوية" @bind="newStudent.CivilstatusIDNumberAndNationalCard">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">صادرة من</label>
                                    <input type="text" class="form-control" placeholder="أدخل جهة الإصدار" @bind="newStudent.CivilstatusIDNumberAndNationalCardFrom">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">تاريخ الإصدار</label>
                                    <input type="date" class="form-control" @bind="newStudent.CivilstatusIDNumberAndNationalCardDate">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الجنسية</label>
                                    <input type="text" class="form-control" placeholder="أدخل الجنسية" @bind="newStudent.Nationality">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">القومية</label>
                                    <input type="text" class="form-control" placeholder="أدخل القومية" @bind="newStudent.PoliticalNationalism">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">رقم شهادة الجنسية</label>
                                    <input type="number" class="form-control" placeholder="أدخل رقم الشهادة" @bind="newStudent.NationalityCertificateNumber">
                                </div>
                            </div>
                        </div>
                    }

                    <!-- المرحلة 5: المعلومات الأكاديمية -->
                    @if (currentStep == 5)
                    {
                        <div class="step-content">
                            <h5 class="mb-4">المعلومات الأكاديمية</h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">اسم المدرسة</label>
                                    <input type="text" class="form-control" placeholder="أدخل اسم المدرسة" @bind="newStudent.SchoolName">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">الفرع</label>
                                    <input type="text" class="form-control" placeholder="أدخل الفرع" @bind="newStudent.Branch">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">تاريخ التخرج</label>
                                    <input type="date" class="form-control" @bind="newStudent.DateOfSchoolGraduate">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">المجموع بدون إضافات</label>
                                    <input type="number" class="form-control" placeholder="أدخل المجموع" @bind="newStudent.StudentTotalWithoutAdditions">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">المجموع مع إضافات</label>
                                    <input type="number" class="form-control" placeholder="أدخل المجموع" @bind="newStudent.StudentTotalWithAdditions">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">المعدل بدون إضافات</label>
                                    <input type="number" class="form-control" placeholder="أدخل المعدل" @bind="newStudent.StudentGPAWithoutAdditions">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">المعدل مع إضافات</label>
                                    <input type="number" class="form-control" placeholder="أدخل المعدل" @bind="newStudent.StudentGPAWithAdditions">
                                </div>
                            </div>
                        </div>
                    }

                    <!-- المرحلة 6: معلومات الحساب والنظام -->
                    @if (currentStep == 6)
                    {
                        <div class="step-content">
                            <h5 class="mb-4">معلومات الحساب والنظام</h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">اسم المستخدم على النظام</label>
                                    <input type="text" class="form-control" placeholder="أدخل اسم المستخدم" @bind="newStudent.UserNameOnSite">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" placeholder="أدخل كلمة المرور" @bind="newStudent.PasswordOnSite">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">حالة الحساب</label>
                                    <select class="form-select" @bind="newStudent.StatusOnSite">
                                        <option value="نشط">نشط</option>
                                        <option value="موقوف">موقوف</option>
                                        <option value="متخرج">متخرج</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">حالة الطالب</label>
                                    <select class="form-select" @bind="newStudent.Status">
                                        <option value="نشط">نشط</option>
                                        <option value="موقوف">موقوف</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">رصيد الحساب</label>
                                    <input type="number" step="0.01" class="form-control" placeholder="أدخل رصيد الحساب" @bind="newStudent.AccountBalance">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">رقم الامتحاني</label>
                                    <input type="number" class="form-control" placeholder="أدخل رقم الامتحان" @bind="newStudent.ExamNumber">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">رقم السري</label>
                                    <input type="number" class="form-control" placeholder="أدخل الرقم السري" @bind="newStudent.SecretNumber">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">تاريخ التسجيل</label>
                                    <input type="date" class="form-control" @bind="newStudent.RegistrationDate">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">رقم وصل الحسابات</label>
                                    <input type="number" class="form-control" placeholder="أدخل رقم الوصل" @bind="newStudent.AccountsReceiptNumber">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">المعدل التراكمي</label>
                                    <input type="number" step="0.01" class="form-control" placeholder="أدخل المعدل التراكمي" @bind="newStudent.GPA">
                                </div>
                            </div>
                        </div>
                    }
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>

                @if (currentStep > 1)
                {
                    <button type="button" class="btn btn-outline-primary" @onclick="PreviousStep">
                        <i class="fas fa-arrow-right me-2"></i>السابق
                    </button>
                }

                @if (currentStep < totalSteps)
                {
                    <button type="button" class="btn btn-primary" @onclick="@(()=>NextStep())">
                        التالي<i class="fas fa-arrow-left ms-2"></i>
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-success" @onclick="SaveStudent">
                        <i class="fas fa-save me-2"></i>حفظ الطالب
                    </button>
                }
            </div>
        </div>
    </div>
</div>
<style>
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin: 0;
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 500;
    }

        .nav-tabs .nav-link.active {
            border-bottom: 3px solid #0d6efd;
            color: #0d6efd;
        }

    .table th {
        font-weight: 600;
    }

    .badge {
        font-size: 0.75em;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .border-start {
        border-left: 4px solid !important;
    }
</style>

@code {
    private string searchTerm = "";
    private List<StudentDto> students = new();
    private List<Student> StudentsList = new();
    private List<DepartmentDto> departments = new();
    private List<Tunnel> tunnels = new();
    private StudentDto newStudent = new();

    // إحصائيات
    private int totalStudents = 0;
    private int activeStudents = 0;
    private int newStudents = 0;
    private double averageGPA = 0;

    // ترقيم الصفحات
    private int currentPage = 1;
    private int totalPages = 1;
    private int pageSize = 10;

    // الفلاتر
    private StudentStatus currentStatus = StudentStatus.All;
    private int? selectedDepartmentId = null;

    private int currentStep = 1;
    private const int totalSteps = 7;
    protected override async Task OnInitializedAsync()
    {
        await LoadDepartments();
        await LoadStatistics();
        await LoadStudents(StudentStatus.All);
    }
    private void NextStep()
    {
        if (currentStep < totalSteps)
        {
            currentStep++;
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 1)
        {
            currentStep--;
        }
    }
    private async Task LoadDepartments()
    {
        try
        {
            departments = await _departmentService.GetAllDepartmentsAsync();
            tunnels = await _context.Tunnels.ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading departments: {ex.Message}");
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            totalStudents = await _studentService.GetTotalStudentsCountAsync();
            activeStudents = await _studentService.GetActiveStudentsCountAsync();
            newStudents = await _studentService.GetNewStudentsCountAsync();
            averageGPA = await _studentService.GetAverageGPAAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading statistics: {ex.Message}");
        }
    }

    private async Task LoadStudents(StudentStatus status)
    {
        try
        {
            currentStatus = status;
            var result = await _studentService.GetStudentsPagedAsync(
                currentPage,
                pageSize,
                searchTerm,
                selectedDepartmentId,
                status);
            var studentsList = result.Data.ToList();
            StudentsList = studentsList;
            students = _mapper.Map<List<StudentDto>>(studentsList);
            totalPages = result.TotalPages;
            totalStudents = result.TotalRecords;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading students: {ex.Message}");
        }
    }

    private async Task SearchStudents(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        currentPage = 1;
        await LoadStudents(currentStatus);
    }

    private async Task FilterByDepartment(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        selectedDepartmentId = string.IsNullOrEmpty(value) ? null : int.Parse(value);
        currentPage = 1;
        await LoadStudents(currentStatus);
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadStudents(currentStatus);
        }
    }

    private string GetDepartmentName(int departmentId)
    {
        var department = departments.FirstOrDefault(d => d.Id == departmentId);
        return department?.Name ?? "غير محدد";
    }

    private string GetAcademicYear(DateTime registrationDate)
    {
        var years = DateTime.Now.Year - registrationDate.Year;
        return years switch
        {
            0 => "السنة الأولى",
            1 => "السنة الثانية",
            2 => "السنة الثالثة",
            3 => "السنة الرابعة",
            _ => "متخرج"
        };
    }

    private async Task SaveStudent()
    {
        try
        {
            await _studentService.CreateStudentAsync(newStudent);
            // إعادة تحميل القائمة
            await LoadStudents(currentStatus);

            await OnInitializedAsync();
            // إعادة تعيين النموذج
            newStudent = new StudentDto();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving student: {ex.Message}");
        }
    }

    private async Task DeleteStudent(string studentId)
    {
        if (await ConfirmDelete())
        {
            try
            {
                await _studentService.DeleteStudentAsync(studentId);
                await LoadStudents(currentStatus);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting student: {ex.Message}");
            }
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        // تنفيذ منطق التأكيد هنا
        return true;
    }

   

}