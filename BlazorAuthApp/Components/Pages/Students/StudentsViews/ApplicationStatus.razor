@page "/apply/status"
@inject UniversityDbContext _context
@rendermode InteractiveServer
<PageTitle>حالة الطلب - الجامعة الذكية</PageTitle>

<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-5">متابعة حالة طلب التقديم</h2>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">البحث عن الطلب</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control" placeholder="أدخل رقم الطلب" @bind="searchTerm" />
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" @onclick="SearchApplication">
                                <i class="fas fa-search me-2"></i>بحث
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @if (applicationStatus != null)
            {
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">تفاصيل الطلب</h5>
                            <span class="badge bg-light text-dark">رقم الطلب: @applicationStatus.Id</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><i class="fas fa-user me-2"></i>الاسم:</h6>
                                <p>@($"{applicationStatus.FirstName} {applicationStatus.LastName}")</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-envelope me-2"></i>البريد الإلكتروني:</h6>
                                <p>@applicationStatus.Email</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><i class="fas fa-building me-2"></i>القسم المطلوب:</h6>
                                <p>@GetDepartmentName(applicationStatus.DepartmentId)</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-calendar me-2"></i>تاريخ التقديم:</h6>
                                <p>@applicationStatus.SubmitDate.ToString("yyyy-MM-dd")</p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6><i class="fas fa-info-circle me-2"></i>حالة الطلب:</h6>
                            <div class="mt-2">
                                @switch (applicationStatus.Status)
                                {
                                    case "قيد المراجعة":
                                        <span class="badge bg-warning fs-6">قيد المراجعة</span>
                                        <p class="mt-2 text-muted">طلبك قيد المراجعة من قبل الإدارة. سيتم إعلامك بالنتيجة خلال 7 أيام عمل.</p>
                                        break;
                                    case "مقبول":
                                        <span class="badge bg-success fs-6">مقبول</span>
                                        <p class="mt-2 text-success">تهانينا! تم قبول طلبك.</p>
                                        @if (!string.IsNullOrEmpty(applicationStatus.StudentId))
                                        {
                                            <div class="alert alert-info mt-3">
                                                <h6><i class="fas fa-key me-2"></i>معلومات الدخول:</h6>
                                                <p>رقم الطالب: <strong>@applicationStatus.StudentId</strong></p>
                                                <p>كلمة المرور المؤقتة: <strong>@applicationStatus.TemporaryPassword</strong></p>
                                                <a href="/student/setup" class="btn btn-primary btn-sm">إعداد الحساب</a>
                                            </div>
                                        }
                                        break;
                                    case "مرفوض":
                                        <span class="badge bg-danger fs-6">مرفوض</span>
                                        <p class="mt-2 text-danger">للأسف، لم يتم قبول طلبك. السبب: @applicationStatus.RejectionReason</p>
                                        break;
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (searchAttempted && applicationStatus == null)
            {
                <div class="alert alert-warning text-center">
                    <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                    <h5>لم يتم العثور على طلب</h5>
                    <p>يرجى التحقق من رقم الطلب المدخل.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string searchTerm = "";
    private StudentApplication? applicationStatus;
    private bool searchAttempted = false;
    private List<Department> departments = new();

    protected override void OnInitialized()
    {
        departments = _context.Departments.ToList();
    }

    private async Task SearchApplication()
    {
        if (string.IsNullOrWhiteSpace(searchTerm)) return;

        searchAttempted = true;

        try
        {
            // البحث عن الطلب في قاعدة البيانات
            if (int.TryParse(searchTerm, out int applicationId))
            {
                applicationStatus =await _context.StudentApplications
                    .FirstOrDefaultAsync(a => a.Id == applicationId);
            }
            else
            {
                applicationStatus =await _context.StudentApplications
                    .FirstOrDefaultAsync(a => a.Email == searchTerm);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching application: {ex.Message}");
        }
    }

    private string GetDepartmentName(int departmentId)
    {
        var department = departments.FirstOrDefault(d => d.Id == departmentId);
        return department?.Name ?? "غير محدد";
    }
   
}